import numpy as np
import tensorflow as tf
from tensorflow.keras.preprocessing import image
from tensorflow.keras.applications.efficientnet import preprocess_input
import matplotlib.pyplot as plt

# configurable paths
MODEL_PATH = 'best_plant_model.h5'
LABELS_PATH = 'labels.txt'

# path of the image to be tested
IMAGE_PATH = '1000068739.jpg' 

# Load the trained Model
print("Loading model...")
model = tf.keras.models.load_model(MODEL_PATH)

# Load the Labels for the classes
try:
    with open(LABELS_PATH, 'r') as f:
        class_names = [line.strip() for line in f.readlines()]
except FileNotFoundError:
    # Fallback if you can't find the text file
    class_names = ['Aloe Vera', 'Areca Palm', 'Snake Plant', 'Yucca'] 

# Load and Preprocess the Image
# Force the image to 224x224 to match the model's input size
img = image.load_img(IMAGE_PATH, target_size=(224, 224))

# Convert to a numpy array of numbers
img_array = image.img_to_array(img)

# Add a "batch" dimension because the model expects the shape (1, 224, 224, 3)
# Shape becomes (1, 224, 224, 3)
img_array = np.expand_dims(img_array, axis=0)

# Use the same preprocessing as during training to prepare the image
input_data = preprocess_input(img_array)

# 4. Make the prediction
print("Classifying...")
predictions = model.predict(input_data)
score = tf.nn.softmax(predictions[0]) # Convert to readable percentages

# 5. Display Result
best_class = class_names[np.argmax(score)]
confidence = 100 * np.max(score)

print(f"\n--------------------------------------")
print(f"Prediction: {best_class}")
print(f"Confidence: {confidence:.2f}%")
print(f"--------------------------------------")

# Shoew the image with the prediction
plt.imshow(img)
plt.title(f"{best_class} ({confidence:.1f}%)")
plt.axis('off')
plt.show()